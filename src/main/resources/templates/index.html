<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />

  <title>Dashboard - NiceAdmin Bootstrap Template</title>
  <meta content="" name="description" />
  <meta content="" name="keywords" />

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect" />
  <link
          href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
          rel="stylesheet"
  />

  <link   href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Favicons -->
    <link th:href="@{/images/DAT.png}" rel="icon">
    <link th:href="@{/images/DAT.png}" rel="apple-touch-icon">


  <link
          th:href="@{/vendor/bootstrap-icons/bootstrap-icons.css}"
          rel="stylesheet"
  />
  <link href="/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" />
  <link href="/vendor/remixicon/remixicon.css" rel="stylesheet" />

  <!-- Template Main CSS File -->
  <link href="/css/style.css" rel="stylesheet" />


    <style>
        .count-box {
            background-color: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .count-icon {
            font-size: 48px;
            color: #007bff; /* Change the color as needed */
        }



    </style>
</head>

<body>
<!-- ======= Header ======= -->
<div th:replace="fragments/header :: header"></div>
<div th:replace="fragments/sidebar :: #sidebar"></div>

    <main id="main" class="main">
      <!-- Breadcrumb part-->
      <div class="pagetitle">
        <nav>
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">user-management</a></li>
            <li class="breadcrumb-item active">save</li>
          </ol>
        </nav>
      </div>
      <!-- End Page Title -->

      <!-- Main Content -->

        <!-- DashBoard MM Header Start -->
        <div class="container mt-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="count-box">
                        <i class='bx bxs-user count-icon' ></i>
                        <p>Number of Users: <span th:text="${userCount}"></span></p>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="count-box">
                        <i class='bx bxs-user count-icon' ></i>
                        <p>Number of Clients: <span th:text="${clientCount}"></span></p>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="count-box">
                        <i class='bx bxs-user count-icon' ></i>
                        <p>Number of Departments: <span th:text="${departmentCount}"></span></p>
                    </div>
                </div>

            </div>
            </div>

        <!-- DashBoard MM Header End -->

        <!-- DashBoard MM Body Start -->
        <div class="container mt-5">
            <label for="yearSelector">Select a year:</label>
            <select id="yearSelector"></select>

            <label for="monthSelector">Select a month:</label>
            <select id="monthSelector">
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
            <label for="departmentSelector">Select a department:</label>
            <select id="departmentSelector">
            </select>
            <label for="projectSelector">Select a project:</label>
            <select id="projectSelector">
            </select>
        </div>
        <div class="container mt-4">
            <div class="row">
                <div class="col-md-8 col-sm-12">
                    <h4>Man Month</h4>
                    <div class="chartBox">
                        <canvas id="manMonthChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12">
                    <h4>Man Month Productivity Ratio</h4>
                    <div class="chartBox">
                        <canvas id="manMonthProductivityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Main Content-->
    </main>
    <!-- End #main -->
    <!-- Vendor JS Files -->
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Template Main JS File -->
    <script src="/js/main.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<!--jquery cdn-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

<script>


    const ctxManMonth = document.getElementById('manMonthChart').getContext('2d');
    const ctxManMonthProductivity = document.getElementById('manMonthProductivityChart').getContext('2d');

    let manMonthChart;
    let manMonthProductivityChart;


    function updateYearSelector() {
        const currentYear = new Date().getFullYear();
        let html = "<option value=''>Select a year</option>";
        for (let year = 2010; year <= currentYear; year++) {
            html += `<option value="${year}">${year}</option>`;
        }
        $("#yearSelector").html(html);
    }
    updateYearSelector();

    function updateDepartmentSelector(data) {
        let html = "<option value=''>Select a department</option>";
        for (const department of data) {
            html += `<option value="${department.id}">${department.name}</option>`;
        }
        $("#departmentSelector").html(html);
    }

    $.get("/api/get-department-data", function (data) {
        updateDepartmentSelector(data);
    });


    $("#yearSelector").on("change", function () {
        updateCharts();
    });


    $("#departmentSelector").on("change", function () {
        const selectedDepartmentId = $(this).val();
        if (selectedDepartmentId) {
            $.get(`/api/get-projects?departmentId=${selectedDepartmentId}`, function (projects) {
                updateProjectSelector(projects);
                updateCharts();
            });
        } else {
            updateProjectSelector([]);
            updateCharts();
        }
    });

    function updateProjectSelector(projects) {
        let html = "<option value=''>Select a project</option>";
        for (const project of projects) {
            html += `<option value="${project.id}">${project.name}</option>`;
        }
        $("#projectSelector").html(html);
    }

    $("#monthSelector").on("change", function () {
        updateCharts();
    });

    $("#projectSelector").on("change", function () {
        updateCharts();
    });

    function updateCharts() {
        const selectedYear = $("#yearSelector").val();
        const selectedProjectId = $("#projectSelector").val();
        const selectedDepartmentId = $("#departmentSelector").val();
        const selectedMonth = $("#monthSelector").val();



        if (selectedProjectId) {
            $.get(`/api/get-tasks?projectId=${selectedProjectId}&month=${selectedMonth}&year=${selectedYear}`, function (tasks) {
                const planManMonths = calculatePlanManMonthForTasks(tasks, selectedMonth, selectedYear);
                const actualManMonths = calculateActualManMonthForTasks(tasks, selectedMonth, selectedYear);
                updateManMonthChart([selectedProjectId], [planManMonths], [actualManMonths]);

                const actualProductivityRatio = calculateManMonthProductivity(actualManMonths, planManMonths);
                updateManMonthProductivity([selectedProjectId], [actualProductivityRatio]);
            });
        } else if (selectedDepartmentId && selectedMonth) {
            $.get(`/api/get-projects?departmentId=${selectedDepartmentId}`, function (projects) {
                const projectLabels = [];
                const planManMonths = [];
                const actualManMonths = [];

                let projectsProcessed = 0;

                function processProject(project) {
                    const projectId = project.id;
                    $.get(`/api/get-tasks?projectId=${projectId}&month=${selectedMonth}&year=${selectedYear}`, function (tasks) {
                        const projectPlanManMonth = calculatePlanManMonthForTasks(tasks, selectedMonth, selectedYear);
                        const projectActualManMonth = calculateActualManMonthForTasks(tasks, selectedMonth, selectedYear);
                        projectLabels.push(project.name);
                        planManMonths.push(projectPlanManMonth);
                        actualManMonths.push(projectActualManMonth);

                        projectsProcessed++;

                        if (projectsProcessed === projects.length) {
                            console.log("All Projects Processed. Updating Chart.");
                            updateManMonthChart(projectLabels, planManMonths, actualManMonths);

                            const departmentProductivityRatios = projects.map((proj, index) => {
                                const projActualManMonths = actualManMonths[index];
                                const projPlanManMonths = planManMonths[index];
                                return calculateManMonthProductivity(projActualManMonths, projPlanManMonths);
                            });

                            updateManMonthProductivity(projectLabels, departmentProductivityRatios);
                        }
                    });
                }

                projects.forEach(processProject);
            });
        } else if (selectedMonth) {
            $.get(`/api/get-department-data`, function (departments) {
                const departmentLabels = [];
                const planManMonths = [];
                const actualManMonths = [];

                let departmentsProcessed = 0;

                function processDepartment(department) {
                    const departmentId = department.id;
                    $.get(`/api/get-projects?departmentId=${departmentId}`, function (projects) {
                        const projectLabels = [];
                        const projectPlanManMonths = [];
                        const projectActualManMonths = [];

                        let projectsProcessed = 0;

                        function processProject(project) {
                            const projectId = project.id;
                            $.get(`/api/get-tasks?projectId=${projectId}&month=${selectedMonth}&year=${selectedYear}`, function (tasks) {
                                const projectPlanManMonth = calculatePlanManMonthForTasks(tasks, selectedMonth, selectedYear);
                                const projectActualManMonth = calculateActualManMonthForTasks(tasks, selectedMonth, selectedYear);
                                projectLabels.push(project.name);
                                projectPlanManMonths.push(projectPlanManMonth);
                                projectActualManMonths.push(projectActualManMonth);

                                projectsProcessed++;

                                if (projectsProcessed === projects.length) {
                                    const departmentPlanManMonth = projectPlanManMonths.reduce((sum, val) => sum + val, 0);
                                    const departmentActualManMonth = projectActualManMonths.reduce((sum, val) => sum + val, 0);

                                    departmentLabels.push(department.name);
                                    planManMonths.push(departmentPlanManMonth);
                                    actualManMonths.push(departmentActualManMonth);

                                    departmentsProcessed++;

                                    if (departmentsProcessed === departments.length) {
                                        updateManMonthChart(departmentLabels, planManMonths, actualManMonths);

                                        const allDepartmentsProductivityRatios = departments.map((dept, index) => {
                                            const deptActualManMonths = actualManMonths[index];
                                            const deptPlanManMonths = planManMonths[index];
                                            return calculateManMonthProductivity(deptActualManMonths, deptPlanManMonths);
                                        });

                                        updateManMonthProductivity(departmentLabels, allDepartmentsProductivityRatios);
                                    }
                                }
                            });
                        }

                        projects.forEach(processProject);
                    });
                }

                departments.forEach(processDepartment);
            });
        }
    }
    let workingDayPerHour = 7.5;
    let workingDayPerMonth = 20;

    function calculatePlanManMonthForTasks(tasks, selectedMonth, selectedYear) {
        let planManMonth = 0;
        for (const task of tasks) {
            if (
                (task.start_date && task.start_date.startsWith(`${selectedYear}-${selectedMonth}`)) ||
                (task.end_date && task.end_date.startsWith(`${selectedYear}-${selectedMonth}`))
            ) {
                planManMonth += task.plan_hours / (workingDayPerHour * workingDayPerMonth);
            }
        }
        return planManMonth;
    }

    function calculateActualManMonthForTasks(tasks, selectedMonth, selectedYear) {
        let actualManMonth = 0;
        for (const task of tasks) {
            if (
                (task.start_date && task.start_date.startsWith(`${selectedYear}-${selectedMonth}`)) ||
                (task.actual_due_date && task.actual_due_date.startsWith(`${selectedYear}-${selectedMonth}`))
            ) {
                actualManMonth += task.actual_hours / (workingDayPerHour * workingDayPerMonth);
            }
        }
        return actualManMonth;
    }

    function calculateManMonthProductivity(actualManMonths, planManMonths) {
        if (planManMonths === 0) {
            return 0;
        }
        return (actualManMonths / planManMonths) * 100;
    }
    function updateManMonthChart(labels, planManMonths, actualManMonths) {
        if (manMonthChart) {
            manMonthChart.destroy();
        }

        const chartData = {
            labels: labels,
            datasets: [
                {
                    label: 'Plan Man Months',
                    data: planManMonths,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Actual Man Months',
                    data: actualManMonths,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        };

        manMonthChart = new Chart(ctxManMonth, {
            type: 'bar',
            data: chartData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function updateManMonthProductivity(labels, actualProductivityRatio) {
        if (manMonthProductivityChart) {
            manMonthProductivityChart.destroy();
        }

        const chartData = {
            labels: labels,
            datasets: [
                {
                    label: 'Actual Productivity Ratio',
                    data: actualProductivityRatio,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                },
            ],
        };

        manMonthProductivityChart = new Chart(ctxManMonthProductivity, {
            type: 'bar',
            data: chartData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                    },
                },
            },
        });
    }

    updateCharts();

</script>
</body>

</html>
