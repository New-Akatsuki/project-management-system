<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Man-Month Filter</title>
  <style>
    .chartBox {
      display: inline-block;
      position: relative;
      width: 100%;
      height: 600px;
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous">
</head>
<body>
<h1>Man-Month Filter</h1>
<label for="monthSelector">Select a month:</label>
<select id="monthSelector">
  <option value="01">January</option>
  <option value="02">February</option>
  <option value="03">March</option>
  <option value="04">April</option>
  <option value="05">May</option>
  <option value="06">June</option>
  <option value="07">July</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">October</option>
  <option value="11">November</option>
  <option value="12">December</option>
</select>


<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 col-sm-12">
      <h4>Man Month Ratio</h4>
      <div class="chartBox">
        <canvas id="manMonthChart"></canvas>
      </div>
    </div>
    <div class="col-md-4 col-sm-12">
      <h4>Man Month Productivity Ratio</h4>
      <div class="chartBox">
        <canvas id="manMonthProductivityChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

<script>
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];

  const ctxManMonth = document.getElementById('manMonthChart').getContext('2d');
  const ctxManMonthProductivity = document.getElementById('manMonthProductivityChart').getContext('2d');

  let manMonthChart;
  let manMonthProductivityChart;

  // Fetch the actual task data using AJAX
  $.get("/get-task-data", function (data) {
    // Filter main tasks (tasks with parent set to null)
    const mainTasks = data.filter(task => task.parent === null);

    // Function to calculate man-months for a specific month
    function calculatePlanManMonth(tasks, selectedMonth) {
      let planManMonth = 0;
      for (const task of tasks) {
        if (
                (task.start_date && task.start_date.startsWith(`2023-${selectedMonth}`)) ||
                (task.end_date && task.end_date.startsWith(`2023-${selectedMonth}`))
        ) {
          planManMonth += task.plan_hours / (8 * 20); // Assuming 8 working hours per day and 20 working days per month
        }
      }
      return planManMonth;
    }

    function calculateActualManMonth(tasks, selectedMonth) {
      let actualManMonth = 0;
      for (const task of tasks) {
        if (
                (task.start_date && task.start_date.startsWith(`2023-${selectedMonth}`)) ||
                (task.actual_due_date && task.actual_due_date.startsWith(`2023-${selectedMonth}`))
        ) {
          actualManMonth += task.actual_hours / (8 * 20);
        }
      }
      return actualManMonth;
    }

    function calculateManMonthProductivityRatio(planManMonth, actualManMonth) {
      if (planManMonth === 0) {
        return 0; // Avoid division by zero
      }
      return (actualManMonth / planManMonth) * 100;
    }

    function updateManMonthChart(selectedMonth) {
      if (manMonthChart) {
        manMonthChart.destroy(); // Destroy the previous chart if it exists
      }
      const taskPlanManMonth = calculatePlanManMonth(mainTasks, selectedMonth);
      const taskActualManMonth = calculateActualManMonth(mainTasks, selectedMonth);
      const chartData = {
        labels: [`${monthNames[selectedMonth - 1]}`],
        datasets: [
          {
            label: 'Plan Man Month',
            data: [taskPlanManMonth],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'Actual Man Month',
            data: [taskActualManMonth],
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      };
      manMonthChart = new Chart(ctxManMonth, {
        type: 'bar',
        data: chartData,
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function updateManMonthProductivityChart(selectedMonth) {
      if (manMonthProductivityChart) {
        manMonthProductivityChart.destroy(); // Destroy the previous chart if it exists
      }
      const taskPlanManMonth = calculatePlanManMonth(mainTasks, selectedMonth);
      const taskActualManMonth = calculateActualManMonth(mainTasks, selectedMonth);
      const productivityRatio = calculateManMonthProductivityRatio(taskPlanManMonth, taskActualManMonth);
      const chartData = {
        labels: [`${monthNames[selectedMonth - 1]}`],
        datasets: [
          {
            label: 'Man Month Productivity Ratio',
            data: [productivityRatio],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }
        ]
      };
      manMonthProductivityChart = new Chart(ctxManMonthProductivity, {
        type: 'bar',
        data: chartData,
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Initialize the charts with January data
    updateManMonthChart("01");
    updateManMonthProductivityChart("01");

    document.getElementById("monthSelector").addEventListener("change", function () {
      const selectedMonth = this.value;
      updateManMonthChart(selectedMonth);
      updateManMonthProductivityChart(selectedMonth);
    });


  });
</script>
</body>
</html>
