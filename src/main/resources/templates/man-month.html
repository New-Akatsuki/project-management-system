<!DOCTYPE html>
<html lang="en">
<head>
  <title>Man-Month Filter</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous">
</head>
<body>
<div>
  <h1>Man-Month Filter</h1>
  <label for="monthSelector">Select a month:</label>
  <select id="monthSelector">
    <option value="01">January</option>
    <option value="02">February</option>
    <option value="03">March</option>
    <option value="04">April</option>
    <option value="05">May</option>
    <option value="06">June</option>
    <option value="07">July</option>
    <option value="08">August</option>
    <option value="09">September</option>
    <option value="10">October</option>
    <option value="11">November</option>
    <option value="12">December</option>
  </select>
  <label for="departmentSelector">Select a department:</label>
  <select id="departmentSelector">
  </select>
  <label for="projectSelector">Select a project:</label>
  <select id="projectSelector">
  </select>
</div>
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 col-sm-12">
      <h4>Man Month</h4>
      <div class="chartBox">
        <canvas id="manMonthChart"></canvas>
      </div>
    </div>
    <div class="col-md-4 col-sm-12">
      <h4>Man Month Productivity Ratio</h4>
      <div class="chartBox">
        <canvas id="manMonthProductivityChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

<script>
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];

  const ctxManMonth = document.getElementById('manMonthChart').getContext('2d');
  const ctxManMonthProductivity = document.getElementById('manMonthProductivityChart').getContext('2d');

  let manMonthChart;
  let manMonthProductivityChart;



  function updateDepartmentSelector(data) {
    let html = "<option value=''>Select a department</option>";
    for (const department of data) {
      html += `<option value="${department.id}">${department.name}</option>`;
    }
    $("#departmentSelector").html(html);
  }

  $.get("/api/get-department-data", function (data) {
    updateDepartmentSelector(data);
  });

  $("#departmentSelector").on("change", function () {
    const selectedDepartmentId = $(this).val();
    if (selectedDepartmentId) {
      $.get(`/api/get-projects?departmentId=${selectedDepartmentId}`, function (projects) {
        updateProjectSelector(projects);
        updateCharts();
      });
    } else {
      updateProjectSelector([]);
        updateCharts();
    }
  });

  function updateProjectSelector(projects) {
    let html = "<option value=''>Select a project</option>";
    for (const project of projects) {
      html += `<option value="${project.id}">${project.name}</option>`;
    }
    $("#projectSelector").html(html);
  }

  $("#monthSelector").on("change", function () {
    updateCharts();
  });

    $("#projectSelector").on("change", function () {
        updateCharts();
    });

  function updateCharts() {
    const selectedProjectId = $("#projectSelector").val();
    const selectedDepartmentId = $("#departmentSelector").val();
    const selectedMonth = $("#monthSelector").val();



    if (selectedProjectId) {
      $.get(`/api/get-tasks?projectId=${selectedProjectId}&month=${selectedMonth}`, function (tasks) {
        const planManMonths = calculatePlanManMonthForTasks(tasks, selectedMonth);
        const actualManMonths = calculateActualManMonthForTasks(tasks, selectedMonth);
        updateManMonthChart([selectedProjectId], [planManMonths], [actualManMonths]);

        const actualProductivityRatio = calculateManMonthProductivity(actualManMonths, planManMonths);
        updateManMonthProductivity(selectedProjectId, actualProductivityRatio);


      });
    } else if (selectedDepartmentId && selectedMonth) {
      $.get(`/api/get-projects?departmentId=${selectedDepartmentId}`, function (projects) {
        const projectLabels = [];
        const planManMonths = [];
        const actualManMonths = [];

        let projectsProcessed = 0;

        function processProject(project) {
          const projectId = project.id;
          $.get(`/api/get-tasks?projectId=${projectId}&month=${selectedMonth}`, function (tasks) {
            const projectPlanManMonth = calculatePlanManMonthForTasks(tasks, selectedMonth);
            const projectActualManMonth = calculateActualManMonthForTasks(tasks, selectedMonth);
            projectLabels.push(project.name);
            planManMonths.push(projectPlanManMonth);
            actualManMonths.push(projectActualManMonth);

            projectsProcessed++;

            if (projectsProcessed === projects.length) {
              console.log("All Projects Processed. Updating Chart.");
              updateManMonthChart(projectLabels, planManMonths, actualManMonths);

              const departmentProductivityRatios = projects.map((proj, index) => {
                const projActualManMonths = actualManMonths[index];
                const projPlanManMonths = planManMonths[index];
                return calculateManMonthProductivity(projActualManMonths, projPlanManMonths);
              });

              updateManMonthProductivity(projectLabels, departmentProductivityRatios);
            }
          });
        }

        projects.forEach(processProject);
      });
    } else if (selectedMonth) {
      $.get(`/api/get-department-data`, function (departments) {
        const departmentLabels = [];
        const planManMonths = [];
        const actualManMonths = [];

        let departmentsProcessed = 0;

        function processDepartment(department) {
          const departmentId = department.id;
          $.get(`/api/get-projects?departmentId=${departmentId}`, function (projects) {
            const projectLabels = [];
            const projectPlanManMonths = [];
            const projectActualManMonths = [];

            let projectsProcessed = 0;

            function processProject(project) {
              const projectId = project.id;
              $.get(`/api/get-tasks?projectId=${projectId}&month=${selectedMonth}`, function (tasks) {
                const projectPlanManMonth = calculatePlanManMonthForTasks(tasks, selectedMonth);
                const projectActualManMonth = calculateActualManMonthForTasks(tasks, selectedMonth);
                projectLabels.push(project.name);
                projectPlanManMonths.push(projectPlanManMonth);
                projectActualManMonths.push(projectActualManMonth);

                projectsProcessed++;

                if (projectsProcessed === projects.length) {
                  const departmentPlanManMonth = projectPlanManMonths.reduce((sum, val) => sum + val, 0);
                  const departmentActualManMonth = projectActualManMonths.reduce((sum, val) => sum + val, 0);

                  departmentLabels.push(department.name);
                  planManMonths.push(departmentPlanManMonth);
                  actualManMonths.push(departmentActualManMonth);

                  departmentsProcessed++;

                  if (departmentsProcessed === departments.length) {
                    updateManMonthChart(departmentLabels, planManMonths, actualManMonths);

                    const allDepartmentsProductivityRatios = departments.map((dept, index) => {
                      const deptActualManMonths = actualManMonths[index];
                      const deptPlanManMonths = planManMonths[index];
                      return calculateManMonthProductivity(deptActualManMonths, deptPlanManMonths);
                    });

                    updateManMonthProductivity(departmentLabels, allDepartmentsProductivityRatios);
                  }
                }
              });
            }

            projects.forEach(processProject);
          });
        }

        departments.forEach(processDepartment);
      });
    }
  }
  let workingDayPerHour = 7.5;
  let workingDayPerMonth = 20;

  function calculatePlanManMonthForTasks(tasks, selectedMonth) {
    let planManMonth = 0;
    for (const task of tasks) {
      if (
              (task.start_date && task.start_date.startsWith(`2023-${selectedMonth}`)) ||
              (task.end_date && task.end_date.startsWith(`2023-${selectedMonth}`))
      ) {
        planManMonth += task.plan_hours / (workingDayPerHour * workingDayPerMonth);
      }
    }
    return planManMonth;
  }

  function calculateActualManMonthForTasks(tasks, selectedMonth) {
    let actualManMonth = 0;
    for (const task of tasks) {
      if (
              (task.start_date && task.start_date.startsWith(`2023-${selectedMonth}`)) ||
              (task.actual_due_date && task.actual_due_date.startsWith(`2023-${selectedMonth}`))
      ) {
        actualManMonth += task.actual_hours / (workingDayPerHour * workingDayPerMonth);
      }
    }
    return actualManMonth;
  }

  function calculateManMonthProductivity(actualManMonths, planManMonths) {
    if (planManMonths === 0) {
      return 0;
    }
    return (actualManMonths / planManMonths) * 100;
  }
  function updateManMonthChart(labels, planManMonths, actualManMonths) {
    if (manMonthChart) {
      manMonthChart.destroy();
    }

    const chartData = {
      labels: labels,
      datasets: [
        {
          label: 'Plan Man Months',
          data: planManMonths,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        },
        {
          label: 'Actual Man Months',
          data: actualManMonths,
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1
        }
      ]
    };

    manMonthChart = new Chart(ctxManMonth, {
      type: 'bar',
      data: chartData,
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  function updateManMonthProductivity(labels, actualProductivityRatio) {
    if (manMonthProductivityChart) {
      manMonthProductivityChart.destroy();
    }

    const chartData = {
      labels: labels,
      datasets: [
        {
          label: 'Actual Productivity Ratio',
          data: actualProductivityRatio,
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1,
        },
      ],
    };

    manMonthProductivityChart = new Chart(ctxManMonthProductivity, {
      type: 'bar',
      data: chartData,
      options: {
        scales: {
          y: {
            beginAtZero: true,
          },
        },
      },
    });
  }

  updateCharts();

</script>
</body>
</html>
